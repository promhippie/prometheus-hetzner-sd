version: '{build}'
image: 'Visual Studio 2017'

clone_folder: 'c:\gopath\src\github.com\promhippie\prometheus-hetzner-sd'

environment:
  GOPATH: c:\gopath
  DOCKER_USERNAME:
    secure: 'hiAQ2emetxm9/e0jpCnVjw=='
  DOCKER_PASSWORD:
    secure: 'K63dhBlHES6R/tOVKDhP/vpv0sRNeM2JIWlsfHUrE8Y='

install:
  - ps: |
      choco install make
  - ps: |
      docker version
      go version
  - ps: |
      $env:Path = "c:\gopath\bin;$env:Path"

build_script:
  - cmd: |
      make retool
  - cmd: |
      make sync
  - cmd: |
      make generate
  - cmd: |
      make build
  - cmd: |
      docker build -f docker/Dockerfile.windows.amd64 -t promhippie/prometheus-hetzner-sd:windows-amd64 .

test_script:
  - cmd: |
      docker run --rm promhippie/prometheus-hetzner-sd:windows-amd64 --help

deploy_script:
  - ps: |
      if ( $env:APPVEYOR_PULL_REQUEST_NUMBER ) {
        Write-Host Nothing to deploy.
      } else {
        echo $env:DOCKER_PASSWORD | docker login --username $env:DOCKER_USERNAME --password-stdin

        if ( $env:APPVEYOR_REPO_TAG -eq 'true' ) {
          $major,$minor,$patch = $env:APPVEYOR_REPO_TAG_NAME.substring(1).split('.')

          docker push promhippie/prometheus-hetzner-sd:windows-amd64

          docker tag promhippie/prometheus-hetzner-sd:windows-amd64 promhippie/prometheus-hetzner-sd:$major.$minor.$patch-windows-amd64
          docker push promhippie/prometheus-hetzner-sd:$major.$minor.$patch-windows-amd64

          docker tag promhippie/prometheus-hetzner-sd:windows-amd64 promhippie/prometheus-hetzner-sd:$major.$minor-windows-amd64
          docker push promhippie/prometheus-hetzner-sd:$major.$minor-windows-amd64

          docker tag promhippie/prometheus-hetzner-sd:windows-amd64 promhippie/prometheus-hetzner-sd:$major-windows-amd64
          docker push promhippie/prometheus-hetzner-sd:$major-windows-amd64
        } else {
          if ( $env:APPVEYOR_REPO_BRANCH -eq 'master' ) {
            docker push promhippie/prometheus-hetzner-sd:windows-amd64
          } else {
            Write-Host Ignoring feature branch.
          }
        }
      }
